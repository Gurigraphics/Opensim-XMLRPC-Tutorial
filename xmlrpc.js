/* 
  Copyright (c) 2006, 2012, Tim Becker (tim@kuriositaet.de)
  All rights reserved.
  Full license details at www.kurisositaet.de/jsxmlrpc/LICENSE.txt
  In short: feel free to do what you want with this, but give me some 
  credit and don't sue me. (BSD License)
  http://kuriositaet.de/javascript/jsxmlrpc.html
*/
  
function getXMLHttpRequest(){for(var e=!1,t=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Microsoft.XMLHTTP")},function(){return new ActiveXObject("Msxml2.XMLHTTP")}],n=0;n!=t.length;++n)try{e=t[n]();break}catch(r){}return e}function checkRequestStatus(e){if(200!=e.status&&0!=e.status){var t=e.status.toString()+" : ";throw(t+=e.statusText?e.statusText:"Network error").errCode=e.status,t}}function readyStateChangeFunc(e,t){return function(){if(e.readyState==Request.COMPLETED)try{checkRequestStatus(e),t(e)}catch(n){e.onnetworkerror(n)}}}function getOnreadystatechangeCallback(e){return arr=["readyState","responseBody","responseStream","responseText","responseXML","status","statusText"],function(){for(var t=0;t!=arr.length;++t)try{e[arr[t]]=e._request[arr[t]]}catch(n){}e.onreadystatechange&&e.onreadystatechange()}}function Request(e,t,n){this.url=e,this.content=t,this.callback=n,this.contentType="text/xml",this.requestMethod=null,this.readyState=0,this.responseBody=null,this.responseStream=null,this.responseText=null,this.responseXML=null,this.status=null,this.statusText=null,this._request=getXMLHttpRequest(),this._request.onreadystatechange=getOnreadystatechangeCallback(this),this.abort=function(){return this._request.abort()},this.getAllResponseHeaders=function(){return this._request.getAllResponseHeaders()},this.getResponseHeader=function(e){return this._request.getResponseHeader(e)},this.open=function(e,t,n,r,s){return void 0===n&&(n=!0),void 0===r&&(r=null),void 0===s&&(s=null),this._request.open(e,t,n,r,s)},this.send=function(e){void 0===e&&(e=""),this._request.send(e)},this.setRequestHeader=function(e,t){var e="Content-Type",t="text/xml";return this._request.setRequestHeader(e,t)},this.copyAttributes=function(){arr=["readyState","responseBody","responseStream","responseText","responseXML","status","statusText"];for(var e=0;e!=arr.length;++e)try{this[arr[e]]=this._request[arr[e]]}catch(t){}},this.process=function(){n&&(this._request.onnetworkerror=this.onnetworkerror,this._request.onreadystatechange=readyStateChangeFunc(this._request,n));var e=!!n;this.requestMethod||(this.content?this.requestMethod="POST":this.requestMethod="GET"),this.open(this.requestMethod,this.url,e),this.setRequestHeader("Content-Length",null!=this.content?this.content.length:0),null!=this.content&&this.setRequestHeader("Content-Type",this.contentType),this.send(this.content),e||(this.copyAttributes(),checkRequestStatus(this))},this.onnetworkerror=function(e){alert(e)}}function isA(e,t){return e.constructor.prototype==t.prototype}function isInt(e){return!!isA(e,Number)&&e%1==0}function isFloat(e){return!!isA(e,Number)&&!isInt(e)}function makeTag(e,t){return"<"+e+">"+t+"</"+e+">"}function visitChildren(e,t,n){eachInNodeList(e.childNodes,t,n)}function eachInNodeList(e,t,n){for(var r=0;r!=e.length;++r)(!n||e[r].nodeType==n)&&t(e[r])}function getTextValueOfChild(e){var t;return visitChildren(e,function(e){t=e.nodeValue},Node.TEXT_NODE),t||(t=""),(t=t.replace(/^\s+/,"")).replace(/\s+$/,"")}function getNamedChild(e,t){var n;return visitChildren(e,function(e){e.nodeName==t&&(n=e)},Node.ELEMENT_NODE),n}function getNamedChildren(e,t){var n=[];return visitChildren(e,function(e){e.nodeName==t&&n.push(e)},Node.ELEMENT_NODE),n}function encodeXmlRpc(e){if(isA(e,String))return makeTag("string",e=(e=(e=e.replace(/&/g,"&amp;")).replace(/</g,"&lt;")).replace(/>/g,"&gt;"));if(isA(e,Boolean))return makeTag("boolean",e?"1":"0");if(isA(e,Date))return makeTag("dateTime.iso8601",getIso8601Str(e));if(isA(e,Array))return makeTag("array",makeTag("data",makeArrayValues(e)));if(!isA(e,Number))return makeTag("struct",makeStructMembers(e));else return isInt(e)?makeTag("int",e):makeTag("double",e)}function makeArrayValues(e){for(var t="",n=0;n!=e.length;++n)t+=makeTag("value",encodeXmlRpc(e[n]));return t}function makeStructMembers(e){var t="";for(var n in e)isA(e[n],Function)||(t+=makeTag("member",makeTag("name",n)+makeTag("value",encodeXmlRpc(e[n]))));return t}function getIso8601Str(e){var t=e.getFullYear().toString(),n=e.getMonth()+1;return n<10&&(t+="0"),t+=n,(day=e.getDate())<10&&(t+="0"),t+=day,t+="T"+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()}function getDateFromChild(e){var t=getTextValueOfChild(e),n=/(\d\d\d\d)(\d\d)(\d\d)T(\d\d):(\d\d):(\d\d)/.exec(t),r=new Number(n[2]);return new Date(n[1],r-1,n[3],n[4],n[5],n[6])}function getArray(e){var t=getNamedChild(e,"data"),n=getNamedChildren(t,"value"),r=[];return eachInNodeList(n,function(e){r.push(getResultFromValueNode(e))},Node.ELEMENT_NODE),r}function getStruct(e){var t,n=getNamedChildren(e,"member"),r={},s=function(e){"name"==e.nodeName&&(t=getTextValueOfChild(e)),"value"==e.nodeName&&(r[t]=getResultFromValueNode(e))};return eachInNodeList(n,function(e){visitChildren(e,s,Node.ELEMENT_NODE)},Node.ELEMENT_NODE),r}function getResultFromValueNode(e){var t,n=e.firstChild;if(null==n)return"";for(;"#text"==n.nodeName;)if(t=n.nodeValue,null==(n=n.nextSibling))return t;switch(n.nodeName){case"string":t=new String(getTextValueOfChild(n));break;case"i4":case"int":case"double":t=new Number(getTextValueOfChild(n));break;case"boolean":t="1"==(tmp=getTextValueOfChild(n));break;case"dateTime.iso8601":t=getDateFromChild(n);break;case"array":t=getArray(n);break;case"struct":t=getStruct(n);break;default:throw"type not handled: "+n.nodeName}return t}function getHandler(e,t){return null==t?null:function(n){t(e.handleAnswer(n.responseXML))}}function XmlRpc(e){this.url=e,this.addArgument=function(e){return makeTag("param",makeTag("value",encodeXmlRpc(e)))},this.onerror=null,this.handleFault=function(e){throw value=getNamedChild(e,"value"),getStruct(struct=getNamedChild(value,"struct"))},this.handleAnswer=function(e){if(null==e)throw"ERROR: no xml returned";var t=e.getElementsByTagName("fault");0!=t.length&&this.handleFault(t[0]);var n=e.getElementsByTagName("param"),r=[];eachInNodeList(n,func=function(e){visitChildren(e,function(e){"value"==e.nodeName&&r.push(e)},Node.ELEMENT_NODE)},Node.ELEMENT_NODE);var s=[];return eachInNodeList(r,function(e){s.push(getResultFromValueNode(e))},Node.ELEMENT_NODE),1==s.length?s[0]:s},this.call=function(){if(0==arguments.length)return null;var e='<?xml version="1.0"?>';e+="<methodCall>",e+=makeTag("methodName",arguments[0]);for(var t="",n=null,r=1;r!=arguments.length;++r){if(isA(arguments[r],Function)){n=arguments[r];break}t+=this.addArgument(arguments[r])}""!=t&&(e+=makeTag("params",t)),e+="</methodCall>";var s=new Request(this.url,e,getHandler(this,n));if(n&&this.onerror&&(s.onnetworkerror=this.onerror),s.process(),null==n)return this.handleAnswer(s.responseXML)}}function addFunction(obj,name,javascriptName){obj[javascriptName]=function(){retVal="",str='retVal = this.call("'+name+'"';for(var i=0;i!=arguments.length;++i)str+=", arguments["+i+"]";return eval(str+=")"),retVal}}Request.UNINITIALIZED=0,Request.LOADING=1,Request.LOADED=2,Request.INTERACTIVE=3,Request.COMPLETED=4,window.Node||(window.Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12}),XmlRpc.getObject=function(e,t){obj=new XmlRpc(e),t=t||obj.call("system.listMethods");for(var n=0;n!=t.length;++n)addFunction(obj,functionName=t[n],functionName.replace(/\./g,"_"));return obj};
